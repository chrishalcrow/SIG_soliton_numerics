<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Experiment summary</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-21bec1194e878605ed49d94bfcede57a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="floating quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#plan-for-the-course-in-krakow" id="toc-plan-for-the-course-in-krakow" class="nav-link" data-scroll-target="#plan-for-the-course-in-krakow">Plan for the course in Krakow</a></li>
  <li><a href="#detailed-plan" id="toc-detailed-plan" class="nav-link" data-scroll-target="#detailed-plan">Detailed Plan</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Experiment summary</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Software engineering is now an integral part of science. As mathematicians and physists, we’re pretty good at understanding algorithms, and even implementing them. But to ensure our code is easy to use, sharbale, reproducible, tested and reliable we need to do a lot more than implement an algorithm. Modern software development involves continuous integration, linters, typers, LSPs, code coverage, automatically-generated docs, and more!</p>
<p>This course will focus on these “soft skills” of software. As such, we’ll be spending a lot of time on setting up our development enviroment and thinking about our workflow. Once we get to coding itself, we’ll go through that quite quickly.</p>
<p>These notes are designed to be self contained. You can start the course RIGHT NOW. You can suggest edits and raise issues on the GitHub page: .</p>
</section>
<section id="plan-for-the-course-in-krakow" class="level1">
<h1>Plan for the course in Krakow</h1>
<p>We have four sessions. In each one, I’ll give a breif introduction to the topic, then you will follow the notes and try and get some code working. If you’d like to spend this time simply working on your existing code: go for it!</p>
<p>By the end of the course, we’ll have made a small package to create a one-dimensional soliton and apply a flow to it. This is not scientifically revolutionary, but the code we make will have many good practices built into it: tests, documentation. It’ll be readable, reproducible and published openly on GitHub. With this structure, I hope you can use this project as a base for future work.</p>
<p>So that everyone has the same experience, we’ll be using Python. If you’d prefer to use a different language, go for it, but I won’t be able to help to easily. C++, Julia and Matlab are all reasonable choices. We will use Python because it’s quite easy to get started with and it’s the most popular (and employable) language in the world. Python is traditionally thought to be slow, and it can be, but if you know how it works it can be just as fast as any other language. I also recommend writing the code in VSCode or PyCharm.</p>
</section>
<section id="detailed-plan" class="level1">
<h1>Detailed Plan</h1>
<p>Before the course: 1. Installation Session 1: 2. Make a Project 3. Git and GitHub Session 2: 4. Source and scripts 5. Functions, classes and methods &lt;– coding only begins here!! 6. Let’s code! Session 3: 7. Compute derivatives and the energy 8. Plot a soliton 9. Save/Load a soliton Session 4: 10. Gradient flow Bonus: 11. Tests 12. Documentation 13. Optimisation 14. Continuous Integration 15. Recommended Reading</p>
<ol type="1">
<li>Install some stuff</li>
</ol>
<p>1.1 The terminal</p>
<p>The terminal is a nice way to interact with your computer. If you’re using Mac or Linux you have a terminal installed already. It’s called Terminal. If you have Windows, you have Powershell. So that everyone has a similar experience, I encourage you to install Windows Terminal (there are installation instructions on the GitHub page: https://docs.astral.sh/uv/#installation)</p>
<p>Open your terminal and type “ls” (short for “list”) then press enter. This will display all the files in your currently directory. If you want to change directories type “cd” followed by the name of the directroy you want to go to.</p>
<p>1.2 uv (to install python)</p>
<p>Python’s biggest asset (and liability) is that people write packages for it. There are over 600,000 packages available on PyPi (https://pypi.org). These packages usually depend on each other, and it can get overwhelming keeping track. As such, we’ll use a installation/package manager called <code>uv</code>. This will install python and the packages for us, and help initialise our project. To install uv follow the instructions on its website: https://docs.astral.sh/uv/#installation. Check it works by opening a Terminal (on Mac or Linux) and typing <code>uv</code>.</p>
<p>Once you have uv, you can run python in the terminal by typing <code>uv run python</code>. The first time you do this uv might install Python. So it might take a little minute.</p>
<p>1.3 An editor</p>
<p>A good text editor <em>really</em> helps coding. A good one allows you to search through codebases, auto-complete code, and more. I recommend VSCode (https://code.visualstudio.com/) because it’s free and has really good Python support. Some people love PyCharm (https://www.jetbrains.com/pycharm/). Please install one.</p>
<p>Both VScode and PyCharm have lots of extensions. For VSCode, please install the Python extension.</p>
<p>1.4 Git</p>
<p>Check that you have git installed by typing ‘git’ then pressing enter in your Terminal. It’s hopefully already installed. If not, please install it https://git-scm.com/book/en/v2/Getting-Started-Installing-Git This is a good moment to make a GitHub account too.</p>
<ol start="2" type="1">
<li>Make a project</li>
</ol>
<p>We’re going to make a Python Package. First choose a name. I’ll be using <code>Solitons1D</code>. Make a folder and name it what you want to call the project. Navigate to this folder in Terminal. Initialise a new python project by typing <code>uv init</code> in Terminal and pressing enter. Go have a look in the folder (either using your File Explorer or typing <code>ls</code> into Terminal). There should be three files inside the folder. uv has made these:</p>
<ul>
<li>pyproject.toml This file contains all the information about your project. Its name, version, description etc. Add some of your own details if you’d like. This file will also keep track of which other packages your package depends on once we add some.</li>
<li>README.md This file is what a new user will first read when they encounter your project. It should contain a description of the project, installation instructions and anything else you’d like. It’s written in markdown, which isn’t too far from plain text (https://www.markdownguide.org/).</li>
<li>main.py An example python script.</li>
</ul>
<p>Ok! Let’s open the project in VSCode. The easiest way to do this is in terminal. We’re going to do something slightly fancy that will make sense later, and open it with uv. Do this by navigating to the project folder in Terminal then typing <code>uv run code .</code>. The dot at the end means “this folder here”. <code>code</code> is the shortcut for VSCode and <code>uv run</code> means “When you open VSCode, make it aware of which python <em>enviroment</em> is being used at the moment”. More on enviroments soon!</p>
<p>VSCode should have opened, and you should see the project directory at the left hand side. There should also be a Terminal at the bottom. If there isn’t you can put it there using <code>View -&gt; Terminal</code>. From the terminal we can run the <code>main.py</code> python script by typing <code>uv run main.py</code> and pressing enter. It should print out “Hello World from {project name}”.</p>
<p>If that’s worked - amazing!! You’ve just set up your developer workflow. I think doing this is actually one of the hardest parts of coding. I’ve shown you my workflow which is fairly standard; but everyone has their own. You can read thousands of articles and YouTube videos (just search neovim for python on YouTube to really start going down the rabbit hole).</p>
<p>2.2 Virtual Enviroments</p>
<p>Ok, I’ve been sweeping the following topic under the rug but it’s very important to understand: virtual enviroments. Because python has so many packages and their dependencies are complex, it’s considered good behaviour to make a different enviroment for different projects. So you might have one enviroment for when you do statistics, one for when you do heavy numerical stuff and another for plotting. <code>uv</code> takes this to the extreme: it makes a new virtual enviroment enviroment every time you run python. When we ran <code>uv run code .</code> it make a folder called <code>.venv</code> containing the information about the enviroment. And when we opened code uv told it that we’re using this enviroment. This means VSCode is aware of which packages we’ve installed. This is gonna be <em>super</em> helpful later.</p>
<p>Let’s add some package dependencies to our package. In the terminal, navigate to your project folder. We’ll add the package numpy by running <code>uv add numpy</code>. This will add numpy to the project by adding it to the <code>pyproject.toml</code> file.</p>
<p>You might notice another new file in your project folder called <code>uv.lock</code>. This keeps all the intricate details about the packages. It’s gross.</p>
<ol start="3" type="1">
<li>Git and GitHub (Optional)</li>
</ol>
<p>Git is version control software. It keeps track of changes you make in the code, so you can easily revert to previous versions. It’s really helpful when you work on a big project with several contributors. When a bug gets introduced you can usually immediately figure out who caused it!</p>
<p>GitHub is run by Microsoft. It’s where you can publish your software. It uses Git to keep track of changes etc.</p>
<p>We need to tell git to track our project, then publish our project on GitHub. This will create a link between our local folder and GitHub page online. To do this, first navigate to project folder in terminal. Then type “git init” and press enter. You can do everything git in the terminal, but I find this quite difficult. Instead, VSCode has great GitHub integration.</p>
<ol start="4" type="1">
<li>Sources and scripts</li>
</ol>
<p>As we build our package, we should keep a separation between the “source” and “scripts”. The source is our package itself. This will contain the logic which can <em>do things</em>, functions like <code>compute_energy</code>, <code>make_soliton</code> and more. Anyone could use this! But when we use the package to do science, we’d write a script. The script will import functions from the source and apply them to a specific case. A script might make a soliton, apply a gradient flow, compute the energy, then plot the result and save the figure as a pdf.</p>
<p>To make this distiction obvious, we’ll make two folders in the project folder. One called “src” (short for source - this shortening is convention) and one called “scripts”. In the “src” folder make a another folder with the name of your package. We’ll also delete the <code>main.py</code> file that uv created. Let’s also create two files in the <code>source/{project_name}</code> folder. One called <code>soliton.py</code> which will contain the code about the soliton and one called <code>__init__.py</code> which tells Python that this folder contained a “module”. Don’t worry about that right now. Also add a script file called <code>investigate_soliton.ipynb</code> in the scripts folder. Overall, my project folder looks like this:</p>
<p>solitons1D/ pyproject.toml README.md scripts/ investigate_soliton.ipynb src/ solitons1D/ <strong>init</strong>.py soliton.py uv.lock</p>
<ol start="5" type="1">
<li>Functions, classes and methods</li>
</ol>
<p>Ok - let’s start coding!!</p>
<p>5.1 Functions</p>
<p>Let’s make a function. Functions take some input and return some output. Let’s make a <code>create_profile</code> function which will generate a profile for a 1D soliton. For now, we’ll just return an array of 0s:</p>
<pre><code>import numpy as np

def create_profile(num_lattice_points):
    profile = np.zeros(num_lattice_points)
    return profile</code></pre>
<p>I’ll write this out in English: “Import the package called numpy and call it np, which is how we’ll be able to access it.” “Define a function called <code>create_profile</code>, which will accept the argument <code>num_lattice_points</code>.” “Use the funcion <code>zeros</code> from the numpy library. (This will create an array of zeros). Assign this array of zeros to the variable <code>profile</code>.” “Return the variable <code>profile</code>. This return signals the end of the function</p>
<p>There are several improvements we can make to code immediately, we can: add type information about the arguments and returned parameter; add a docstring describing the function.</p>
<pre><code>import numpy as np

def create_profile(num_lattice_points: int) -&gt; np.array:
    """
    Creates a profile function for a lattice with 
    `num_lattice_points` points.

    Parameters
    ----------
    num_lattice_points: int
        Number of lattice points

    Returns
    -------
    profile: np.array
        Generated profile function 
    """

    profile = np.zeros(num_lattice_points)
    return profile</code></pre>
<p>Ok. Let’s use this function. We’re going to use <code>investigate_soliton.ipynb</code>. This is a Jupyter notebook. To use it, we need to add another package to our package. In the terminal, navigate to the project folder, type “uv add ipykernel” then press enter. Ok, now open <code>investigate_soliton.ipynb</code> in VSCode.</p>
<p>A Jupyter notebook allows you to run little snippets of code in a “cell”. We need to import our function from our package, then run it. Put this code in your first cell</p>
<pre><code>from solitons1d.soliton import create_profile
profile = create_profile(100)
profile</code></pre>
<p>and execute this (either by pressing the “play” button next to the cell or pressing shift+enter). The final line of the cell gets displayed underneate it. So we should see a large array of 0s.</p>
<p>5.2 Classes and methods</p>
<p>Functions are fine. But classes are the heart of object-orientated programming. A class represents an object. In <code>src/soliton.py</code>, let’s make a class which will represent a soliton. When you make an instance of a class (called an object), it is “initialised”. Here, we can choose what information to store in the object.</p>
<pre><code>class Soliton():

    def __init__(self, num_lattice_points, lattice_spacing):
         self.lp = num_lattice_points
     self.ls = lattice_spacing
     self.profile = create_profile(num_lattice_points)</code></pre>
<p>In English: “Define a class called Soliton” “Define the initialisation method, which will accept two integers, the number of lattice points and the lattice spacing.” “store the number of lattice points” “store the lattice_spacing” “Make a profile using the <code>create_profile</code> function and store it in <code>profile</code>.</p>
<p>Now, back in your script, make a Soliton object:</p>
<pre><code>from solitons1d import Soliton
my_soliton = Soliton(100,0.1)
print(my_soliton.lp)</code></pre>
<p>“from the solitons1d package, import the class Soliton” “use the Soliton class to initialise a soliton with 100 lattice points and 0.1 lattice spacing called <code>my_soliton</code>” “take the soliton I just made, and get the number of lattice points. Print this.”</p>
<p>Great! Hopefully you can see that it’s helpful to have an object that contains some information.</p>
<p>5.3 Methods</p>
<p>Even more helpful: write class-specific functions that can change what’s in the object. These are called “methods”. They’re similar to functions but are designed to only apply to the class. These are defined in the class definition itself. Let’s create a method which will (eventually) compute the energy of the soliton. The Soliton class method get updated to the following:</p>
<pre><code>class Soliton():

    def __init__(self, num_lattice_points, lattice_spacing):
         self.lp = num_lattice_points
     self.ls = lattice_spacing
     self.profile = create_profile(num_lattice_points)

    def compute_energy(self)

         total_energy = np.sum(self.profile)
     total_energy *= self.ls
     self.energy = total_energy</code></pre>
<p>Now we have a method that takes in the profile function, sums it up, multiplies this value by the lattice spacing, stores the value in <code>self.energy</code> then returns this value. We can use it in a script as follows:</p>
<pre><code>my_soliton.compute_energy()
print(my_soliton.energy)</code></pre>
<p>We’ve now got the basic building block that we’ll use for the rest of the course. Let’s now do a bunch of coding…</p>
<ol start="6" type="1">
<li>Writing some code</li>
</ol>
<p>6.1 Make a Lagrangian class</p>
<p>6.2 Make a Grid class</p>
<p>6.3 Update the Soliton class</p>
<p>6.4 Make an initial profile function</p>
<hr>
<ol start="7" type="1">
<li>Compute the energy</li>
</ol>
<p>Ok, let’s slow down to compute the energy</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/chrishalcrow\.github\.io\/SIG_soliton_numerics\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>