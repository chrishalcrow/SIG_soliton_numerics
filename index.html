<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Good Scientific Software Practices, through Solitons</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-905433ffa22618bb005779f2b23c5ce0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="floating quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation"><span class="header-section-number">1</span> Installation</a>
  <ul class="collapse">
  <li><a href="#the-terminal" id="toc-the-terminal" class="nav-link" data-scroll-target="#the-terminal"><span class="header-section-number">1.1</span> The terminal</a></li>
  <li><a href="#uv-to-install-python-packages" id="toc-uv-to-install-python-packages" class="nav-link" data-scroll-target="#uv-to-install-python-packages"><span class="header-section-number">1.2</span> uv (to install python + packages)</a></li>
  <li><a href="#an-editor" id="toc-an-editor" class="nav-link" data-scroll-target="#an-editor"><span class="header-section-number">1.3</span> An editor</a></li>
  <li><a href="#git" id="toc-git" class="nav-link" data-scroll-target="#git"><span class="header-section-number">1.4</span> Git</a></li>
  </ul></li>
  <li><a href="#make-a-project" id="toc-make-a-project" class="nav-link" data-scroll-target="#make-a-project"><span class="header-section-number">2</span> Make a project</a>
  <ul class="collapse">
  <li><a href="#virtual-enviroments" id="toc-virtual-enviroments" class="nav-link" data-scroll-target="#virtual-enviroments"><span class="header-section-number">2.1</span> Virtual Enviroments</a></li>
  </ul></li>
  <li><a href="#git-and-github" id="toc-git-and-github" class="nav-link" data-scroll-target="#git-and-github"><span class="header-section-number">3</span> Git and GitHub</a></li>
  <li><a href="#sources-and-scripts" id="toc-sources-and-scripts" class="nav-link" data-scroll-target="#sources-and-scripts"><span class="header-section-number">4</span> Sources and scripts</a></li>
  <li><a href="#functions-classes-and-methods" id="toc-functions-classes-and-methods" class="nav-link" data-scroll-target="#functions-classes-and-methods"><span class="header-section-number">5</span> Functions, classes and methods</a>
  <ul class="collapse">
  <li><a href="#functions" id="toc-functions" class="nav-link" data-scroll-target="#functions"><span class="header-section-number">5.1</span> Functions</a></li>
  <li><a href="#classes-and-methods" id="toc-classes-and-methods" class="nav-link" data-scroll-target="#classes-and-methods"><span class="header-section-number">5.2</span> Classes and methods</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods"><span class="header-section-number">5.3</span> Methods</a></li>
  <li><a href="#upload-to-github" id="toc-upload-to-github" class="nav-link" data-scroll-target="#upload-to-github"><span class="header-section-number">5.4</span> Upload to GitHub</a></li>
  </ul></li>
  <li><a href="#lots-of-code" id="toc-lots-of-code" class="nav-link" data-scroll-target="#lots-of-code"><span class="header-section-number">6</span> Lots of code!</a>
  <ul class="collapse">
  <li><a href="#the-grid-class" id="toc-the-grid-class" class="nav-link" data-scroll-target="#the-grid-class"><span class="header-section-number">6.1</span> The <code>Grid</code> class</a></li>
  <li><a href="#make-a-lagrangian-class" id="toc-make-a-lagrangian-class" class="nav-link" data-scroll-target="#make-a-lagrangian-class"><span class="header-section-number">6.2</span> Make a <code>Lagrangian</code> class</a></li>
  <li><a href="#update-the-soliton-class" id="toc-update-the-soliton-class" class="nav-link" data-scroll-target="#update-the-soliton-class"><span class="header-section-number">6.3</span> Update the <code>Soliton</code> class</a></li>
  </ul></li>
  <li><a href="#derivatives-and-energy" id="toc-derivatives-and-energy" class="nav-link" data-scroll-target="#derivatives-and-energy"><span class="header-section-number">7</span> Derivatives and Energy</a></li>
  <li><a href="#plot-a-soliton" id="toc-plot-a-soliton" class="nav-link" data-scroll-target="#plot-a-soliton"><span class="header-section-number">8</span> Plot a Soliton</a></li>
  <li><a href="#saveload-a-soliton" id="toc-saveload-a-soliton" class="nav-link" data-scroll-target="#saveload-a-soliton"><span class="header-section-number">9</span> Save/load a Soliton</a>
  <ul class="collapse">
  <li><a href="#saveload-a-grid" id="toc-saveload-a-grid" class="nav-link" data-scroll-target="#saveload-a-grid"><span class="header-section-number">9.1</span> Save/Load a Grid</a></li>
  <li><a href="#saveload-a-lagrangian" id="toc-saveload-a-lagrangian" class="nav-link" data-scroll-target="#saveload-a-lagrangian"><span class="header-section-number">9.2</span> Save/Load a Lagrangian</a></li>
  <li><a href="#saveload-a-soliton-1" id="toc-saveload-a-soliton-1" class="nav-link" data-scroll-target="#saveload-a-soliton-1"><span class="header-section-number">9.3</span> Save/Load a Soliton</a></li>
  </ul></li>
  <li><a href="#gradient-flow" id="toc-gradient-flow" class="nav-link" data-scroll-target="#gradient-flow"><span class="header-section-number">10</span> Gradient flow</a></li>
  <li><a href="#bonus" id="toc-bonus" class="nav-link" data-scroll-target="#bonus"><span class="header-section-number">11</span> Bonus</a>
  <ul class="collapse">
  <li><a href="#timing-and-optimization" id="toc-timing-and-optimization" class="nav-link" data-scroll-target="#timing-and-optimization"><span class="header-section-number">11.1</span> Timing and Optimization</a></li>
  <li><a href="#refactoring" id="toc-refactoring" class="nav-link" data-scroll-target="#refactoring"><span class="header-section-number">11.2</span> Refactoring</a></li>
  <li><a href="#init__" id="toc-init__" class="nav-link" data-scroll-target="#init__"><span class="header-section-number">11.3</span> <code>__init__</code></a></li>
  <li><a href="#make-a-library-of-lagrangians" id="toc-make-a-library-of-lagrangians" class="nav-link" data-scroll-target="#make-a-library-of-lagrangians"><span class="header-section-number">11.4</span> Make a library of Lagrangians</a></li>
  <li><a href="#ideas-to-build-on-the-codebase" id="toc-ideas-to-build-on-the-codebase" class="nav-link" data-scroll-target="#ideas-to-build-on-the-codebase"><span class="header-section-number">11.5</span> Ideas to build on the codebase</a></li>
  <li><a href="#advice-on-making-code-and-figures-for-papers" id="toc-advice-on-making-code-and-figures-for-papers" class="nav-link" data-scroll-target="#advice-on-making-code-and-figures-for-papers"><span class="header-section-number">11.6</span> Advice on making code and figures for papers</a></li>
  <li><a href="#tests" id="toc-tests" class="nav-link" data-scroll-target="#tests"><span class="header-section-number">11.7</span> Tests</a></li>
  </ul></li>
  <li><a href="#coming-soon" id="toc-coming-soon" class="nav-link" data-scroll-target="#coming-soon"><span class="header-section-number">12</span> Coming soon…</a>
  <ul class="collapse">
  <li><a href="#linters-and-formatters" id="toc-linters-and-formatters" class="nav-link" data-scroll-target="#linters-and-formatters"><span class="header-section-number">12.1</span> Linters and formatters</a></li>
  <li><a href="#documentation" id="toc-documentation" class="nav-link" data-scroll-target="#documentation"><span class="header-section-number">12.2</span> Documentation</a></li>
  <li><a href="#continuous-integration" id="toc-continuous-integration" class="nav-link" data-scroll-target="#continuous-integration"><span class="header-section-number">12.3</span> Continuous Integration</a></li>
  <li><a href="#recommended-readinglisteningwatching" id="toc-recommended-readinglisteningwatching" class="nav-link" data-scroll-target="#recommended-readinglisteningwatching"><span class="header-section-number">12.4</span> Recommended Reading/Listening/Watching</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Good Scientific Software Practices, through Solitons</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1 unnumbered unlisted">
<h1 class="unnumbered unlisted">Introduction</h1>
<p>Software engineering is now an integral part of science. As mathematicians and physicists, we’re pretty good at understanding algorithms, and even implementing them. But to ensure our code is easy to use, sharable, reproducible, tested and reliable we need to do a lot more than implement an algorithm. Modern software development involves continuous integration, linters, typers, LSPs, code coverage, automatically-generated docs, and more!</p>
<p>This course will focus on these “soft skills” of software. As such, we’ll be spending a lot of time setting up our project and development environment and thinking about our workflow. Then once we get to coding itself, I’m not really going to give you much advice or help you to understand the code itself. Hopefully it’s fairly self-explanatory and you can use your favorite search engine or LLM to understand the code. Try sharing a piece of code from the course with an LLM and ask some questions about it. Or ask it to improve the code.</p>
<p>These notes are designed to be self contained. You can start the course RIGHT NOW. You can suggest edits and raise issues on the <a href="https://github.com/chrishalcrow/SIG_soliton_numerics/tree/gh-pages">GitHub page</a>.</p>
<section id="plan-for-the-course-in-krakow" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="plan-for-the-course-in-krakow"><span class="header-section-number">0.1</span> Plan for the course in Krakow</h2>
<p>We have four sessions. In each one, I’ll give a brief introduction to the topic, then you will follow the notes and try and get some code working. If you’d like to spend this time simply working on your existing code: go for it!</p>
<p>By the end of the course, we’ll have made a small package to create a one-dimensional soliton and apply a flow to it. This is not scientifically revolutionary, but the code we make will have many good practices built into it. It will have tests and documentation. It’ll be readable, reproducible and published openly on GitHub. With this structure, I hope you can use this project as a base for future work.</p>
<p>So that everyone has the same experience, we’ll be using Python. If you’d prefer to use a different language, go for it! You’ll have to translate the Python code/concepts here into your favorite language, but that shouldn’t be too hard. Julia, C++ and Matlab are all reasonable choices. We will use Python because it’s quite easy to get started with and it’s the most popular (and employable) language in the world. Python is traditionally thought to be slow, and it can be. But if you know how it works it can be just as fast as any other language. I also recommend writing the code in VSCode or PyCharm.</p>
</section>
<section id="detailed-plan" class="level2" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="detailed-plan"><span class="header-section-number">0.2</span> Detailed Plan</h2>
<ol type="1">
<li>Before the course:</li>
</ol>
<ul>
<li>Installation</li>
</ul>
<ol start="2" type="1">
<li>Monday</li>
</ol>
<ul>
<li>Make a Project</li>
<li>Git and GitHub</li>
</ul>
<ol start="3" type="1">
<li>Tuesday</li>
</ol>
<ul>
<li>Source and scripts</li>
<li>Functions, classes and methods &lt;– coding only begins here!!</li>
<li>Lots of code!</li>
</ul>
<ol start="4" type="1">
<li>Thursday</li>
</ol>
<ul>
<li>Compute derivatives and the energy</li>
<li>Plot a soliton</li>
<li>Save/Load a soliton</li>
</ul>
<ol start="5" type="1">
<li>Friday</li>
</ol>
<ul>
<li>Gradient flow</li>
</ul>
<ol start="6" type="1">
<li>Bonus</li>
</ol>
<ul>
<li>Tests</li>
<li>Documentation</li>
<li>Optimization</li>
<li>Linters, formatters and LSPs</li>
<li>Continuous Integration</li>
<li>Recommended Reading</li>
</ul>
</section>
</section>
<section id="installation" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Installation</h1>
<section id="the-terminal" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="the-terminal"><span class="header-section-number">1.1</span> The terminal</h2>
<p>The terminal is a way to interact with your computer using text commands. If you’re using Mac or Linux you have a terminal installed already. It’s called Terminal. If you have Windows, you have Powershell. So that everyone has a similar experience, I encourage you to install Windows Terminal (there are installation instructions on <a href="https://github.com/microsoft/terminal">its GitHub page</a>)</p>
<p>Open your terminal and type “ls” (short for “list”) then press enter. This will display all the files in your currently directory. If you want to change directories type “cd” followed by the name of the directroy you want to go to.</p>
</section>
<section id="uv-to-install-python-packages" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="uv-to-install-python-packages"><span class="header-section-number">1.2</span> uv (to install python + packages)</h2>
<p>Python’s biggest asset (and liability) is that people write packages for it. There are over 600,000 packages available on <a href="https://pypi.org">PyPi</a>. These packages usually depend on each other, and it can get overwhelming keeping track. As such, we’ll use a installation/package manager called <code>uv</code>. This will install python and the packages for us, and help initialise our project. To install uv follow the instructions on <a href="https://docs.astral.sh/uv/#installation">uv’s website</a>. Check it works by opening a Terminal (on Mac or Linux) and typing <code>uv</code>.</p>
<p>Once you have uv, you can run python in the terminal by typing <code>uv run python</code>. The first time you do this uv might install Python. So it might take a little minute.</p>
</section>
<section id="an-editor" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="an-editor"><span class="header-section-number">1.3</span> An editor</h2>
<p>A good text editor <em>really</em> helps coding. A good one allows you to search through codebases, auto-complete code, and more. I recommend <a href="https://code.visualstudio.com/">VSCode</a> because it’s free and has really good Python support. Some people love <a href="https://www.jetbrains.com/pycharm/">PyCharm</a>. Please install one.</p>
<p>Both VScode and PyCharm have lots of extensions. For VSCode, please install the Python extension.</p>
</section>
<section id="git" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="git"><span class="header-section-number">1.4</span> Git</h2>
<p>Check that you have git installed by typing ‘git’ then pressing enter in your Terminal. It’s hopefully already installed. If not, <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">please install it</a> This is a good moment to make a <a href="https://github.com/">GitHub account too</a>.</p>
</section>
</section>
<section id="make-a-project" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Make a project</h1>
<p>We’re going to make a Python Package. First choose a name. I’ll be using <code>solitons1d</code>. Find a place you want to store your project and go to that directory in Terminal. Initialise a new python package by typing e.g.&nbsp;<code>uv init --package solitons1d</code> in Terminal and pressing enter. Go have a look in the folder (either using your File Explorer or typing <code>ls</code> into Terminal). There should be four files inside the folder. uv has made these:</p>
<ul>
<li>README.md This file is what a new user will first read when they encounter your project. It should contain a description of the project, installation instructions and anything else you’d like. It’s written in markdown, which isn’t too far from plain text (https://www.markdownguide.org/).</li>
<li>pyproject.toml This file contains all the information about your project. Its name, version, description etc. Add some of your own details if you’d like. This file will also keep track of which other packages your package depends on once we add some.</li>
<li>uv.lock Keeps the <em>detailed</em> information about package dependencies.</li>
<li>src/solitons1d. A folder which will contain your package.</li>
</ul>
<p>Ok! Let’s open the project in VSCode. The easiest way to do this is in terminal. We’re going to do something slightly fancy that will make sense later, and open it with uv. Do this by navigating to the project folder in Terminal then typing <code>uv run code .</code>. The dot at the end means “this folder here”. <code>code</code> is the shortcut for VSCode and <code>uv run</code> means “When you open VSCode, make it aware of which python <em>environment</em> is being used at the moment”. More on environments soon!</p>
<p>VSCode should have opened, and you should see the project directory at the left hand side. There should also be a Terminal at the bottom. If there isn’t you can put it there using <code>View -&gt; Terminal</code>. From the terminal we can run python by entering <code>uv run python</code>, then import our package using <code>import solitons1d</code>. Quit python by running <code>exit()</code>. Note: we won’t use python in the terminal much.</p>
<p>If that didn’t error - amazing!! You’ve just set up your developer workflow. I think doing this is actually one of the hardest parts of coding. I’ve shown you my workflow which is fairly standard; but everyone has their own. You can read thousands of articles and YouTube videos (just search neovim for python on YouTube to really start going down the rabbit hole).</p>
<section id="virtual-enviroments" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="virtual-enviroments"><span class="header-section-number">2.1</span> Virtual Enviroments</h2>
<p>I’ve been sweeping the following topic under the rug but it’s very important to understand: virtual environments. Because python has so many packages and their dependencies are complex, it’s considered good behaviour to make a different environment for different projects. So you might have one environment for when you do statistics, one for when you do heavy numerical stuff and another for plotting. <code>uv</code> takes this to the extreme: it makes a new virtual environment every time you run python. When we ran <code>uv run code .</code> it make a folder called <code>.venv</code> containing the information about the environment. Then it opened VSCode and told it that we’re using this environment. This means VSCode is aware of which packages we’ve installed. This is gonna be <em>super</em> helpful later.</p>
<p>Now we’ll add some packages to our project - this tells <code>uv</code> that when we create the virtual environment it should install these packages. In the terminal, navigate to your project folder. Add the package numpy by running <code>uv add numpy</code>. This will add numpy to the project by adding it to the <code>pyproject.toml</code> file.</p>
</section>
</section>
<section id="git-and-github" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Git and GitHub</h1>
<p>Git is version control software. It keeps track of changes you make in the code, so you can easily revert to previous versions. It’s really helpful when you work on a big project with several contributors. When a bug gets introduced you can usually immediately figure out who caused it!</p>
<p>GitHub is run by Microsoft. It’s where you can publish your software. It uses Git to keep track of changes etc.</p>
<p>The idea here is to have one copy of your project on your local computer, and one copy of your project on GitHub. We’ll then link the two copies together, so changes you make locally can get applied to the remote (GitHub) copy. Then GitHub takes care of a lot of nice things, which we’ll get on to later.</p>
<p>There are lots of ways to link your local and remote repos. For more info, try: https://github.com/git-guides/git-init .</p>
<p>It can get a bit messy at the start here, <strong>so please follow these instructions carefully:</strong></p>
<p>We’ll make a GitHub repository (repo) and link it to this folder. Go to github.com, make an account then create a new repository. DON’T DO ANYTHING except add the repository name, then press “Create repository”. Towards the bottom of the next page you should see the heading “…or push an existing repository from the command line”, with some commands to run. Something like:</p>
<pre><code>git remote add origin https://github.com/chrishalcrow/solitons1D.git
git branch -M main
git push -u origin main</code></pre>
<p>Run these three commands from your local repo folder in Terminal. They say:</p>
<ul>
<li>“Link the git in this folder to this github repository”</li>
<li>“Create the primary ‘branch’ of the repo, called main”</li>
<li>“Push (put, or add) everything from the folder to the repo on github.com”</li>
</ul>
<p>If that worked: great! You’re project is now <em>online</em>! If the last one error’d, that’s ok. We’ll get that sorted soon.</p>
<p>Note that GitHub is useful for any project work you’re doing. This website is hosted on GitHub. Even better: GitHub <em>builds</em> this website using its compute power. And it’s free - very cool!</p>
</section>
<section id="sources-and-scripts" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Sources and scripts</h1>
<p>As we build our package, we should keep a separation between the “source” and “scripts”. The source is our package itself. This will contain the logic which can <em>do things</em> and that you want to share with other people. Functions like <code>compute_energy</code> or <code>make_soliton</code>. But when we use the package to do science, we’d write a script. The script will import functions from the source and apply them to a specific case. A script might make a soliton, apply a gradient flow, compute the energy, then plot the result and save the figure as a pdf.</p>
<p>To make this distinction obvious, we’ll keep two folders in the project folder. One called “src” that <code>uv</code> already created for us (short for source - this shortening is conventional) and one called “scripts”. In the “src” there should already be another folder called the name of your package. Inside this there is a file called <code>__init__.py</code> which tells Python that this folder contains a “module”. Let’s create another files in the <code>source/{project_name}</code> folder called <code>soliton.py</code>, which will contain the code about the soliton, Also add a script file called <code>play.ipynb</code> in the scripts folder. Overall, my project folder looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>solitons1D<span class="op">/</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    pyproject.toml</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    README.md</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    scripts<span class="op">/</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        play.ipynb</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    src<span class="op">/</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        solitons1D<span class="op">/</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">__init__</span>.py</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            soliton.py</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    uv.lock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="functions-classes-and-methods" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Functions, classes and methods</h1>
<p>Ok - let’s start coding!!</p>
<section id="functions" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="functions"><span class="header-section-number">5.1</span> Functions</h2>
<p>Let’s make a function. Functions take some input and return some output. Let’s make a <code>create_profile</code> function which will generate a profile for a 1D soliton. For now, we’ll just return an array of 0s:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_profile(num_grid_points):</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    profile <span class="op">=</span> np.zeros(num_grid_points)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> profile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’ll write this out in English:</p>
<ul>
<li>“Import the package called numpy and call it np, which is how we’ll be able to access it.”</li>
<li>“Define a function called <code>create_profile</code>, which will accept the argument <code>num_grid_points</code>.”</li>
<li>“Use the function <code>zeros</code> from the numpy library. (This will create an array of zeros). Assign this array of zeros to the variable <code>profile</code>.”</li>
<li>“Return the variable <code>profile</code>. This return signals the end of the function.</li>
</ul>
<p>There are several improvements we can make to code immediately, we can: add type information about the arguments and returned parameters; add a docstring describing the function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_profile(num_grid_points: <span class="bu">int</span>) <span class="op">-&gt;</span> np.array:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a profile function for a grid with </span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    `num_grid_points` points.</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    num_grid_points: int</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of grid points</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">    profile: np.array</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Generated profile function </span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    profile <span class="op">=</span> np.zeros(num_grid_points)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> profile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(notes on choosing variable/function names: https://inventwithpython.com/beyond/chapter4.html)</p>
<p>Let’s use this function. We’re going to use <code>play.ipynb</code>. This is a Jupyter notebook. To use it, we need to install another package to our environment. In the terminal, navigate to the project folder, type “uv add ipykernel” then press enter. Now open <code>play.ipynb</code> in VSCode.</p>
<p>A Jupyter notebook allows you to run little snippets of code in a “cell”. We need to import our function from our package, then run it. Put this code in your first cell</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d.soliton <span class="im">import</span> create_profile</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>profile <span class="op">=</span> create_profile(<span class="dv">100</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>profile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and execute this (either by pressing the “play” button next to the cell or pressing shift+enter). The final line of the cell gets displayed underneate it. So we should see a large array of 0s.</p>
</section>
<section id="classes-and-methods" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="classes-and-methods"><span class="header-section-number">5.2</span> Classes and methods</h2>
<p>Functions are fine. But classes are the heart of object-orientated programming. Think of a class as an abstract definition like a Group (from Group Theory). Then we can create objects which conform to the class definition (like we can create <span class="math inline">\(D_4\)</span>, a specific example of a group). In <code>src/soliton.py</code>, let’s make a class which will represent a soliton. When you make a specific instance of a class (object), it is “initialised”. During initialisation, we can choose what information to store in the object.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Soliton():</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_grid_points, grid_spacing):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.num_grid_points <span class="op">=</span> num_grid_points</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.grid_spacing <span class="op">=</span> grid_spacing</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.profile <span class="op">=</span> create_profile(num_grid_points)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In English:</p>
<ul>
<li>“Define a class called Soliton”</li>
<li>“Define the initialisation method, which will accept two numbers, the number of grid points and the grid spacing.”</li>
<li>“store the number of grid points”</li>
<li>“store the grid spacing”</li>
<li>“Make a profile function using the <code>create_profile</code> function and store it in <code>profile</code>.</li>
</ul>
<p>Now, back in the <code>play.ipynb</code> notebook, we can make a Soliton object:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d <span class="im">import</span> Soliton</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>my_soliton <span class="op">=</span> Soliton(<span class="dv">100</span>,<span class="fl">0.1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_soliton.num_grid_points)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“from the solitons1d package, import the class Soliton”</li>
<li>“use the Soliton class to initialise a soliton with 100 grid points and 0.1 grid spacing called <code>my_soliton</code>”</li>
<li>“take the soliton I just made, and get the number of grid points. Print this.”</li>
</ul>
<p>Great! Hopefully you can see that it’s helpful to have an object that contains some information.</p>
</section>
<section id="methods" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="methods"><span class="header-section-number">5.3</span> Methods</h2>
<p>Even more helpful: write class-specific functions that can change what’s in the object. These are called “methods”. They’re similar to functions but are designed to only be applied to the class. These are defined in the class definition itself. Let’s create a method which will (eventually) compute the energy of the soliton. The Soliton class gets updated to the following:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Soliton():</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_grid_points, grid_spacing):</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.lp <span class="op">=</span> num_grid_points</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.ls <span class="op">=</span> grid_spacing</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.profile <span class="op">=</span> create_profile(num_grid_points)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_energy(<span class="va">self</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>         total_energy <span class="op">=</span> np.<span class="bu">sum</span>(<span class="va">self</span>.profile)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>         total_energy <span class="op">*=</span> <span class="va">self</span>.ls</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.energy <span class="op">=</span> total_energy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we have a method that takes in the profile function, sums it up, multiplies this value by the grid spacing, stores the value in <code>self.energy</code> then returns this value. We can use it in a script as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>my_soliton.compute_energy()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_soliton.energy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We’ve now got the basic building block that we’ll use for the rest of the course.</p>
</section>
<section id="upload-to-github" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="upload-to-github"><span class="header-section-number">5.4</span> Upload to GitHub</h2>
<p>Now that we have a few functions, methods, and classes: let’s sync our local folder with our GitHub repository. You can do this using the Terminal (), but VSCode has some great Git integration. So let’s use that. Find the “Source Control” button in VSCode. When you press it, it should show a list of files that you have made changes to. The logic is:</p>
<ol type="1">
<li>“Stage” the files you want to sync to GitHub. Do this by selecting the files you want to stage, right-clicking, then choosing “Stage Files”.</li>
<li>Commit and Push the staged files to GitHub. Do this by first writing a message in the Message box. Maybe “Added Soliton class”. Then press the down arrow at the right hand side of the commit button, and click “Commit and Push”.</li>
</ol>
<p>The first time you do this, you might need to Publish your branch. Every other time, it’s just the 2-step process above.</p>
<p>Now go to your github page (mine is github.com/chrishalcrow/solitons1d/) and see if your changes have appeared there.</p>
</section>
</section>
<section id="lots-of-code" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Lots of code!</h1>
<p>Let’s get starting coding! I’ll explain the overall structure of the codebase, then we’ll go through the actual code very quickly. In each subsection, I’ll get an overview then present the code.</p>
<p>Our centerpiece is the <code>Soliton</code> class. The <code>Soliton</code> will contain a <code>Grid</code> object and a <code>Lagrangian</code> object, keeping the numerical grid maintained and the mathematical details of the theory respectively. By doing this, each <code>Soliton</code> will know what theory is belongs to - handy. A <code>Soliton</code> object will contain methods allowing one to create an initial profile function, compute the energy and gradient flow.</p>
<p>Note: Another programmer might make this differently. Maybe having a <code>Grid</code> class is overkill. Maybe allowing the user to specify a generic Lagrangian is silly - you might just hardcode the Lagrangian you’d like in your <code>Soliton</code> object. Play around, debate, and figure out your style.</p>
<section id="the-grid-class" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="the-grid-class"><span class="header-section-number">6.1</span> The <code>Grid</code> class</h2>
<p>A user can create a grid by specifying the number of grid points and the grid spacing. The <code>Grid</code> will then compute a grid (saved as <code>numpy</code> array) and save the length of the grid.</p>
<p>Add this to <code>soliton.py</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Grid:</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">    A 1D grid.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    num_grid_points : int</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of grid points used in grid.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">    grid_spacing : float</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Spacing between grid points.</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Attributes</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">    grid_length : float</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Total length of grid.</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">    grid_points : np.array[float]</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">        An array of grid points, of the grid.</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        num_grid_points: <span class="bu">int</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        grid_spacing: <span class="bu">float</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_grid_points <span class="op">=</span> num_grid_points</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.grid_spacing <span class="op">=</span> grid_spacing</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.grid_length <span class="op">=</span> (num_grid_points) <span class="op">*</span> grid_spacing</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.grid_points <span class="op">=</span> np.arange(</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span><span class="va">self</span>.grid_length <span class="op">/</span> <span class="dv">2</span>, <span class="va">self</span>.grid_length <span class="op">/</span> <span class="dv">2</span>, grid_spacing</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Possible improvements:</p>
<ul>
<li>Allow the user to specify the grid in other ways: by providing the start and end points, for example. Question: How do you make the code flexible to allow the user to do several different things. Hint: <code>If num_grid_points is None:</code></li>
</ul>
<p>Question:</p>
<ul>
<li>What’s the difference between a Parameter and an Attribute?</li>
</ul>
<p>Use. Make a grid as follow in a script:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d.soliton <span class="im">import</span> Grid</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>my_grid <span class="op">=</span> Grid(<span class="dv">200</span>,<span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="make-a-lagrangian-class" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="make-a-lagrangian-class"><span class="header-section-number">6.2</span> Make a <code>Lagrangian</code> class</h2>
<p>The Lagrangian will keep track of the potential function. We won’t set up automatic differentiation, so we’ll also give the Lagrangian the derivative of the potential. We’ll also optionally allow the user to input the vacua of the theory. If they do, we’ll add a check that the derivative function of the vacua return 0. This class could also be where we define how many fields our theory has, any funny metric, and more. But let’s keep it simple for now.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Lagrangian:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Used to represent Lagrangians of the form:</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">        L = - 1/2(dx_phi)^2 - V(phi)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">    V : function</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">        The potential energy function, must be a map from R -&gt; R</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">    dV : function</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">        The derivative of the potential energy function, must be a map from R -&gt; R</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    vacua : list-like or None</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">        List of vacua of the potential energy.</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        V: Callable[[<span class="bu">float</span>], <span class="bu">float</span>], <span class="co"># Yup - you can pass functions are argument in python!</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        dV: Callable[[<span class="bu">float</span>], <span class="bu">float</span>],</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        vacua: <span class="bu">list</span> <span class="op">|</span> np.ndarray <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,  <span class="co"># np.ndarray is the type of a numpy array</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.V <span class="op">=</span> V</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dV <span class="op">=</span> dV</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vacua <span class="op">=</span> vacua</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> vacua <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> vacuum <span class="kw">in</span> vacua:</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                <span class="co"># np.isclose does what it sounds like: are the values close?</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                <span class="co"># That f"" is called an f-string, allowing you to add parameters to strings</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">assert</span> np.isclose(dV(vacuum), <span class="dv">0</span>), (</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"The given vacua do not satisfy dV(</span><span class="sc">{</span>vacuum<span class="sc">}</span><span class="ss">) = 0"</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>                )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Use:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d.soliton <span class="im">import</span> Lagrangian</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phi4_V(x):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.5</span><span class="op">*</span>np.<span class="bu">pow</span>(<span class="dv">1</span><span class="op">-</span>np.<span class="bu">pow</span>(x,<span class="dv">2</span>),<span class="dv">2</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phi4_dV(x):</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span>np.<span class="bu">pow</span>(x,<span class="dv">3</span>) <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>x</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>phi4_lagrangian <span class="op">=</span> Lagrangian(V<span class="op">=</span>phi4_V, dV<span class="op">=</span>phi4_dV, vacua<span class="op">=</span>[<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Possible improvements:</p>
<ul>
<li>Add an automatic differentiation package to compute <code>dV</code> from <code>V</code>.</li>
<li>Allow for multiple fields, different metric terms, time (harder - do you need to make a TimeGrid??).</li>
<li>Delete this and make it part of the <code>Soliton</code> class?? Is this an improvement, or not? Why?</li>
<li>Add library of common Lagrangians, so that the user doesn’t have to specify the potential every time.</li>
<li>Add a plotting function which plots the potential and its derivative.</li>
</ul>
<p>Questions:</p>
<ul>
<li>Why put an <code>assert</code> where we did? Better as a test?</li>
<li>Can you edit the example code so that the <code>assert</code> is triggered?</li>
</ul>
</section>
<section id="update-the-soliton-class" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="update-the-soliton-class"><span class="header-section-number">6.3</span> Update the <code>Soliton</code> class</h2>
<p>Time to update the <code>Soliton</code> class to use the <code>Grid</code> and <code>Lagrangian</code> classes. When initialising the soliton, we’ll allow the user to specify an initial profile function: either by specifying a function or passing an array representing the initial profile. We’ll add a <code>compute_energy</code> method, and do something a bit odd: create another function called <code>compute_energy_fast</code>. Roughly: the method in the class strips out what we need from the object and passes this to <code>compute_energy_fast</code>: this second function doesn’t interact with the class at all and we can optimize the heck out of it later. This is THE KEY concept to get the benefits of: 1) Lovely user-friendly classes 2) FAST STUFF. For now, we won’t implement the energy function, but we will set up the machinery to do it later.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Soliton:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    A class describing a Soliton.</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    grid : Grid</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">        The grid underpinning the soliton.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    lagrangian : Lagrangian</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">        The Lagrangian of the theory supporting the soliton.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">    initial_profile_function : None | function</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">        The initial profile function, must be from R -&gt; R. Optional.</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">    initial_profile : None | array-like</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">        The initial profile function as an array. Optional.</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        grid: Grid,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        lagrangian: Lagrangian,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        initial_profile_function: Callable[[<span class="bu">float</span>], <span class="bu">float</span>] <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        initial_profile: np.ndarray <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.grid <span class="op">=</span> grid</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lagrangian <span class="op">=</span> lagrangian</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.profile <span class="op">=</span> np.zeros(grid.num_grid_points)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (initial_profile_function <span class="kw">is</span> <span class="va">None</span>) <span class="kw">or</span> (initial_profile <span class="kw">is</span> <span class="va">None</span>), (</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Please only specify `initial_profile_function` or `profile_function`"</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> initial_profile_function <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.profile <span class="op">=</span> create_profile(<span class="va">self</span>.grid.grid_points, initial_profile_function)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.profile <span class="op">=</span> initial_profile</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.energy <span class="op">=</span> <span class="va">self</span>.compute_energy()</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_energy(<span class="va">self</span>):</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Computes the energy of a soliton, and stores this in `Soliton.energy`."""</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        energy <span class="op">=</span> compute_energy_fast(</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lagrangian.V,</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.profile,</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.grid.num_grid_points,</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.grid.grid_spacing,</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.energy <span class="op">=</span> energy</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_energy_fast(V, profile, num_grid_points, grid_spacing):</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    total_energy <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_energy</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_profile(</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    grid_points: np.array,</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    initial_profile_function: Callable[[np.array], np.array] <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.array:</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a profile function on a grid, from profile function `initial_profile_function`.</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a><span class="co">    grid_points: Grid</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="co">        The x-values of a grid.</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="co">    initial_profile_function: function</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a><span class="co">        A function which accepts and returns a 1D numpy array</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="co">    profile: np.array</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a><span class="co">        Generated profile function</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    profile <span class="op">=</span> initial_profile_function(grid_points)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> profile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Example code:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d.soliton <span class="im">import</span> Lagrangian, Grid, Soliton</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phi4_V(x):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.5</span><span class="op">*</span>np.<span class="bu">pow</span>(<span class="dv">1</span><span class="op">-</span>np.<span class="bu">pow</span>(x,<span class="dv">2</span>),<span class="dv">2</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phi4_dV(x):</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span>np.<span class="bu">pow</span>(x,<span class="dv">3</span>) <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>x</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>phi4_lagrangian <span class="op">=</span> Lagrangian(V<span class="op">=</span>phi4_V, dV<span class="op">=</span>phi4_dV, vacua<span class="op">=</span>[<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>my_grid <span class="op">=</span> Grid(<span class="dv">20</span>,<span class="fl">0.1</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>my_soliton <span class="op">=</span> Soliton(my_grid, phi4_lagrangian, initial_profile_function<span class="op">=</span>np.tanh)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_soliton.profile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Improvements:</p>
<ul>
<li>If a user passes an <code>initial_profile</code>, check it’s the right length.</li>
</ul>
<p>Questions:</p>
<ul>
<li>What are all these <code>self</code>s about??</li>
<li>Can you trigger the <code>assert</code> by playing with the example code?</li>
<li>Before going on to the next section: try to write the <code>compute_energy_fast</code> function, or part of it.</li>
<li>We’ve edited the <code>create_profile</code> function to fit in with our class. How has it changed? Why?</li>
</ul>
<p>You’ve now seen quite a lot of Python code. This might be a good time to read PEP8, the Zen of Python, and some tips about writing “Pythonic” code (https://inventwithpython.com/beyond/chapter6.html).</p>
</section>
</section>
<section id="derivatives-and-energy" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Derivatives and Energy</h1>
<p>To compute the energy, and the gradient flow, we’ll need to compute derivatives. There are many ways to do this. The most common in the soliton field is using a finite difference method. Here, we implement the approximation</p>
<p><span class="math display">\[
\phi'(x) = \lim_{\epsilon \to 0}\frac{\phi(x+\epsilon) - \phi(x-\epsilon)}{2\epsilon}
\]</span></p>
<p>on our rigid grid. This can be approximated in many ways. You get more accuracy if you use more points. But if your true function does change fast and your points are too widely spread you’ll hit numerical blow-ups. For solitons, I usually use a fourth-accuracy method. If we use <code>i</code> to denote the lattice point, the fourth order derivative approximates the derivative on the grid as follows:</p>
<p><span class="math display">\[
(\partial \phi)_i = \frac{1}{12}\phi_{i-2} - \frac{2}{3}\phi_{i-1} + \frac{2}{3}\phi_{i+1} - \frac{1}{12}\phi_{i+2}
\]</span></p>
<p>You can find other accuracies on <a href="https://en.wikipedia.org/wiki/Finite_difference_coefficient">Wikipedia</a>.</p>
<p>The big problem is the boundary. When we try to compute the derivative at the <code>0</code>th point, it tries to access the <code>-1</code>th point, which doesn’t exist. Here are a few solutions:</p>
<ul>
<li>Use Dirichlet boundary conditions. So keep the boundary fixed. Since you’re keeping it fixed, you don’t need to update it and hence you don’t need to compute the derivative there. Easy!</li>
<li>Use forward/backwards finite difference to approximate the boundary points.</li>
<li>Use Neumann boundary conditions. Keep the derivative equal to zero. If you do this, then at the boundary you can set <span class="math inline">\(\phi_{-1} = \phi_{1}\)</span> and <span class="math inline">\(\phi_{-2} = \phi_2\)</span>, and you don’t need to worry.</li>
<li>Use (possibly shifted) periodic boundary conditions, so that <span class="math inline">\(\phi_{-1} = \phi_{N}\)</span> and <span class="math inline">\(\phi_{-2} = \phi_{N-1}\)</span>.</li>
</ul>
<p>We’re going to do the simplest: Dirichlet. A good exercise: implement something else.</p>
<p>So, we’ll write functions to compute the first and (while we’re at it) second derivatives of a function. (This is going to be a FAST function, so we don’t want it to interact with the class):</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_first_derivative(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    phi: np.ndarray, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    num_grid_points: <span class="bu">int</span>, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    grid_spacing: <span class="bu">float</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    For a given array, computes the first derivative of that array.</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    phi: np.ndarray</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Array to get the first derivative of</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">    num_grid_points: int</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Length of the array</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">    grid_spacing: float</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Grid spacing of underlying grid</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">    d_phi: np.ndarray</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">        The first derivative of `phi`.</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    d_phi <span class="op">=</span> np.zeros(num_grid_points)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> np.arange(num_grid_points)[<span class="dv">2</span>:<span class="op">-</span><span class="dv">2</span>]:</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        d_phi[i] <span class="op">=</span> (phi[i <span class="op">-</span> <span class="dv">2</span>] <span class="op">-</span> <span class="dv">8</span> <span class="op">*</span> phi[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">+</span> <span class="dv">8</span> <span class="op">*</span> phi[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">-</span> phi[i <span class="op">+</span> <span class="dv">2</span>]) <span class="op">/</span> (</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>            <span class="fl">12.0</span> <span class="op">*</span> grid_spacing</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d_phi</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_second_derivative(</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    phi: np.ndarray, </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    num_grid_points: <span class="bu">int</span>, </span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    grid_spacing: <span class="bu">float</span>,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="co">    For a given array, computes the first derivative of that array.</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="co">    phi: np.ndarray</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Array to get the first derivative of</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="co">    num_grid_points: int</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Length of the array</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="co">    grid_spacing: float</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="co">        Grid spacing of underlying grid</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="co">    d_phi: np.ndarray</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="co">        The first derivative of `phi`.</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    ddV <span class="op">=</span> np.zeros(num_grid_points)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> np.arange(num_grid_points)[<span class="dv">2</span>:<span class="op">-</span><span class="dv">2</span>]:</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        ddV[i] <span class="op">=</span> (</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>phi[i <span class="op">-</span> <span class="dv">2</span>] <span class="op">+</span> <span class="dv">16</span> <span class="op">*</span> phi[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">-</span> <span class="dv">30</span> <span class="op">*</span> phi[i] <span class="op">+</span> <span class="dv">16</span> <span class="op">*</span> phi[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">-</span> phi[i <span class="op">+</span> <span class="dv">2</span>]</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">/</span> (<span class="fl">12.0</span> <span class="op">*</span> np.<span class="bu">pow</span>(grid_spacing, <span class="dv">2</span>))</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ddV</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With these derivative functions, computing the energy is easy. We just estimate the integral as a sum,</p>
<p><span class="math display">\[
E = \int \mathcal{E}(x) dx \approx (\Delta x)\sum_i \mathcal{E}_i \, ,
\]</span></p>
<p>like so:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_energy_fast(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    V: Callable[[<span class="bu">float</span>], <span class="bu">float</span>],</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    profile: np.array, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    num_grid_points: <span class="bu">int</span>, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    grid_spacing: <span class="bu">float</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes the energy of a Lagrangian of the form</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">        E = 1/2 (d_phi)^2 + V(phi)</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">    V: function</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">        The potential energy function</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    profile: np.ndarray</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">        The profile function of the soliton</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    num_grid_points: int</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Length of `profile`</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">    grid_spacing: float</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Grid spacing of underlying grid</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    dx_profile <span class="op">=</span> get_first_derivative(profile, num_grid_points, grid_spacing)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    kin_eng <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> np.<span class="bu">pow</span>(dx_profile, <span class="dv">2</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    pot_eng <span class="op">=</span> V(profile)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    tot_eng <span class="op">=</span> np.<span class="bu">sum</span>(kin_eng <span class="op">+</span> pot_eng) <span class="op">*</span> grid_spacing</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tot_eng</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Example code, following on from last time</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>my_soliton.compute_energy()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_soltion.energy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Improvements:</p>
<ul>
<li>Allow for any type of boundary conditions</li>
<li>Allow for any kind of kinetic energy</li>
</ul>
<p>Questions: - You could get <code>num_grid_points</code> by computing <code>len(profile)</code>. How would this improve your code? How would this make your code worse?</p>
</section>
<section id="plot-a-soliton" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Plot a Soliton</h1>
<p>We’re now making and computing solitons - let’s take a look at what we’re plotting. The most popular plotting package in Python is matplotlib. We need to install it by navigating to our Project folder in Terminal and running <code>uv add matplotlib</code>. In matplotlib, you’ve got a <code>Figure</code> which contains <code>Axes</code>. You can plot stuff on an <code>axis</code>, and adjust ticks and titles. Our code will look like:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>ax.plot(x,y)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"hello!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And it makes sense and WE LOVE IT. When you Google matplotlib you’ll find lots of code that looks like <code>plt.plot(x,y); plt.show()</code>. WE HATE THIS!!!! (ask me about it later)</p>
<p>So, the plan is to make a plotting method of the <code>Soliton</code> class that will return a matplotlib figure. It’s nice to play with plotting in a Jupyter notebook. Here’s my attempt at a reasonable plotting method. This is a method of the class, so should be indented in the class:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_soliton(<span class="va">self</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Makes a plot of the profile function of your soliton"""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        ax.plot(<span class="va">self</span>.grid.grid_points, <span class="va">self</span>.profile)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Profile function. Energy = </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>energy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Code example, following on from earlier:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if you run just this first line in a Jupyter cell, it should display a figure</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> my_soliton.plot_soliton()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">"my_lovely_soliton.pdf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="saveload-a-soliton" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Save/load a Soliton</h1>
<p>When saving any numerical objects, you should save enough data so that it can be reconstructed. For our Soliton class this is actually quite complex because we need to save the <code>Lagrangian</code> and the <code>Grid</code> too; and the Lagrangian includes generic functions. When the object is this complex we should probably save it as a folder. The folder should contain enough information to reconstruct the object. Ideally, any data which can be should be in a “human readable” format like <code>json</code> or <code>yaml</code>.</p>
<p>We’ll go a bit further and make a save/load function for the <code>Grid</code> and <code>Lagrangian</code> objects too. These will also be contained in a folder. Overall the <code>Soliton</code> export will look like</p>
<pre><code>my_soliton/
    profile.npz
    metadata.json
    grid/
        metadata.json
    lagrangian
        metadata.json
        potential.pkl</code></pre>
<p>This might be a bit of an overkill for this project.</p>
<section id="saveload-a-grid" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="saveload-a-grid"><span class="header-section-number">9.1</span> Save/Load a Grid</h2>
<p>The <code>Grid</code> is an easy object to save and load because it can be reconstructed from just the number of lattice points and the lattice spacing. We first add a <code>save</code> method to the <code>Grid</code> class. This will involve some new “standard” packages: <code>json</code> and <code>pathlib</code>. The standard packages are packages with basic Python, so you don’t need to add them using <code>uv</code>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add near the top of the file</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># add to Grid class</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        folder_name: <span class="bu">str</span> <span class="op">|</span> Path,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Saves a `Grid` object at `folder_name`.</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> {</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"num_grid_points"</span>: <span class="va">self</span>.num_grid_points,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"grid_spacing"</span>: <span class="va">self</span>.grid_spacing</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make the folder a Path if it is a string</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        folder <span class="op">=</span> Path(folder_name)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        folder.mkdir(exist_ok <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this overwrites any existing metadata.json file</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(folder <span class="op">/</span> <span class="st">"metadata.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>            json.dump(metadata, f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The loading function is a function, <em>not</em> a method (why?). It should read the json file, make a <code>Grid</code> object and return it</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_grid(folder_name: <span class="bu">str</span> <span class="op">|</span> Path):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Loads the `Grid` object at `folder_name`.</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> Path(folder_name)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    metadata_path <span class="op">=</span> folder <span class="op">/</span> <span class="st">"metadata.json"</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> metadata_path.is_file(), <span class="ss">f"Could not find Grid `metadata.json` file in </span><span class="sc">{</span>folder<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(metadata_path, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        grid_metadata <span class="op">=</span> json.load(f)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the ** "unpacks" the dictionary into a series of arguments</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> Grid(<span class="op">**</span>grid_metadata)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using it:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d.soliton <span class="im">import</span> load_grid</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>my_grid <span class="op">=</span> Grid(<span class="dv">100</span>,<span class="fl">0.1</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>my_grid.save(<span class="st">"my_lovely_grid"</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>my_loaded_grid <span class="op">=</span> load_grid(<span class="st">"my_lovely_grid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="saveload-a-lagrangian" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="saveload-a-lagrangian"><span class="header-section-number">9.2</span> Save/Load a Lagrangian</h2>
<p>The <code>Lagrangian</code> is more complicated: we need a save the potential and the derivative of the potential, which are generic functions. We’ll do this using the <code>pickle</code> format, which can save any Python object (note: you could use this to save the full <code>Soliton</code> object).</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle <span class="im">as</span> pkl</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add to Lagrangian class</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        folder_name: <span class="bu">str</span> <span class="op">|</span> Path,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Saves a `Lagrangian` object at `folder_name`.</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> {</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"V"</span>: <span class="va">self</span>.V,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"dV"</span>: <span class="va">self</span>.dV,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"vacua"</span>: <span class="va">self</span>.vacua,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make the folder a Path if it is a string</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        folder <span class="op">=</span> Path(folder_name)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        folder.mkdir(exist_ok <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(folder <span class="op">/</span> <span class="st">"metadata.pkl"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>            pkl.dump(metadata, f)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="co"># add to main body</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_lagrangian(folder_name: <span class="bu">str</span> <span class="op">|</span> Path):</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Loads the `Lagrangian` object at `folder_name`.</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> Path(folder_name)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    metadata_path <span class="op">=</span> folder <span class="op">/</span> <span class="st">"metadata.pkl"</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> metadata_path.is_file(), <span class="ss">f"Could not find Lagrangian `metadata.json` file in </span><span class="sc">{</span>folder<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(metadata_path, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>        lagrangian_metadata <span class="op">=</span> pkl.load(f)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the ** "unpacks" the dictionary into a series of arguments</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    lagrangian <span class="op">=</span> Lagrangian(<span class="op">**</span>lagrangian_metadata)</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lagrangian</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Questions:</p>
<ul>
<li>Save a <code>Lagrangian</code> and a <code>Grid</code>, and take a look in the folder. Why might you prefer <code>json</code> to <code>pickle</code>?</li>
</ul>
</section>
<section id="saveload-a-soliton-1" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="saveload-a-soliton-1"><span class="header-section-number">9.3</span> Save/Load a Soliton</h2>
<p>Now we want to save the Soliton, including any profile funciton we’ve made. Since we compute the energy on instantiation we’ll also save this as a property. Let’s go:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>        folder_name: <span class="bu">str</span> <span class="op">|</span> Path,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Saves a `Soliton` object at `folder_name`.</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        folder <span class="op">=</span> Path(folder_name)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        folder.mkdir(exist_ok <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        grid_folder <span class="op">=</span>  <span class="st">"./grid"</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        lagrangian_folder <span class="op">=</span> <span class="st">"./lagrangian"</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> {</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'grid_folder'</span>: <span class="bu">str</span>(grid_folder),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lagrangian_folder'</span>: <span class="bu">str</span>(lagrangian_folder),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        properties <span class="op">=</span> {</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'energy'</span>: <span class="va">self</span>.energy</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.grid.save(grid_folder)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lagrangian.save(lagrangian_folder)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(folder <span class="op">/</span> <span class="st">"metadata.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>            json.dump(metadata, f)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(folder <span class="op">/</span> <span class="st">"properties.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>            json.dump(properties, f)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># use `numpy`s save function to save the profile array</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        np.save(<span class="st">"profile"</span>, <span class="va">self</span>.profile)</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_soliton(folder_name):</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Loads the `Lagrangian` object at `folder_name`.</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> Path(folder_name)</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    metadata_path <span class="op">=</span> folder <span class="op">/</span> <span class="st">"metadata.json"</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> metadata_path.is_file(), <span class="ss">f"Could not find Grid `metadata.json` file in </span><span class="sc">{</span>folder<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(metadata_path, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>        soliton_metadata <span class="op">=</span> json.load(f)</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    grid_folder <span class="op">=</span> soliton_metadata.get(<span class="st">"grid_folder"</span>)</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> load_grid(grid_folder)</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    lagrangian_folder <span class="op">=</span> soliton_metadata.get(<span class="st">"lagrangian_folder"</span>)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>    lagrangian <span class="op">=</span> load_lagrangian(lagrangian_folder)</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    profile <span class="op">=</span> np.load(<span class="st">"profile.npy"</span>)</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    soliton <span class="op">=</span> Soliton(grid <span class="op">=</span> grid, lagrangian<span class="op">=</span>lagrangian, initial_profile<span class="op">=</span>profile)</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> soliton</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Exercise: save a soliton, and load it.</p>
<p>Note: We’ve written more code to save and load our objects than we will to gradient flow them. Ouch.</p>
</section>
</section>
<section id="gradient-flow" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Gradient flow</h1>
<p>Exercise: Write a gradient flow function. This should implement the following mathematical evolution:</p>
<p><span class="math display">\[
\dot{\phi} = - \frac{\delta E}{\delta \phi}
\]</span></p>
<p><span class="math display">\[
\dot{\phi} = \partial_x^2 \phi - \partial_\phi V[\phi]
\]</span></p>
<p>The user should be able to use the method follows:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Energy before flow: </span><span class="sc">{</span>my_soliton<span class="sc">.</span>energy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>my_soliton.gradient_flow(steps<span class="op">=</span><span class="dv">1000</span>, dt<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>my_soliton.compute_energy()</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Energy after flow: </span><span class="sc">{</span>my_soliton<span class="sc">.</span>energy<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You’ll actually write two functions: a <code>gradient_flow</code> method in the <code>Soltion</code> class and a <code>gradient_flow_fast</code> function in the body of the code.</p>
<p><strong>End of “core” course</strong></p>
</section>
<section id="bonus" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Bonus</h1>
<section id="timing-and-optimization" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="timing-and-optimization"><span class="header-section-number">11.1</span> Timing and Optimization</h2>
<p>Let’s make our functions FAST.</p>
<p>We’ll do this using <code>numba</code>. Numba is a big-fry package: Nvidia use it for their python implemtation of CUDA (their GPU library). Roughly, when we “numbafy” a function, when the complier first sees the function it compiles it into highly-optimized C code. But it can only do this to certain functions. Roughly: it likes for loops and <code>numpy</code> functions. It hates strings, dictionaries and dataframes. More read here:</p>
<p>Before we make the code fast, let’s see how fast it is now. We’ll do the timing using the <code>perf_counter</code> from the <code>time</code> standard library. To really see a difference in 1D code we need to make a silly example. Let’s make a giant grid, then compute the derivative lots of times using <code>get_first_derivative</code>, and time it:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> perf_counter</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d.soliton <span class="im">import</span> get_first_derivative</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>array_length <span class="op">=</span> <span class="dv">100_000</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>random_big_array <span class="op">=</span> np.random.random(array_length)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> []</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> perf_counter()</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    get_first_derivative(random_big_array, num_grid_points<span class="op">=</span>array_length, grid_spacing<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    t2 <span class="op">=</span> perf_counter()</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    times.append(t2<span class="op">-</span>t1)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.median(times))</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="fl">0.04206724999676226</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So computing the derivative of a <code>100_000</code> long array took 0.04206724999676226 seconds.</p>
<p>To use <code>numba</code> we need to add it to our package (<code>uv add numba</code>) then “decorate” our <code>get_first_derivative</code> function using <code>njit</code> by doing the following in <code>soliton.py</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> njit</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_first_derivative(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>njit</code> means “no-python just-in-time compliation”. More: “when the compiler first meets this function, compile it <em>just</em> as you use it. Try to make pure C++ code. In fact, if you can’t do this and still have some python in it: throw an error!”.</p>
<p>Restart your jupyter kernel, and rerun the timing script. I now get a time of 0.00010070799908135086 seconds, a speed-up of <span class="math inline">\(\times 420\)</span>!!!!!</p>
<p>Now, the reason this worked so easily is because we set up the code structure so that numba would be easy to implement. Doing this from scratch is kinda difficult. Luckily, all our code is numba-fy-able. We just need to decorate lots of funcitons with <code>@njit</code>. I’ve added it to</p>
<ul>
<li><code>compute_energy_fast</code></li>
<li><code>grad_flow_fast</code></li>
<li><code>get_first_derivative</code></li>
<li><code>get_second_derivative</code></li>
<li><code>compute_dE</code></li>
</ul>
<p>Note: you need to <code>@njit</code> the Lagrangian’s functions too when you make it.</p>
<p>The other functions and methods don’t need to be fast.</p>
<p><code>numba</code> also allows for parallelisation if we tell if which loops are parallelisable. ALL of ours are!! We can tell it that they are parallelisable by using a <code>prange</code> (parallel range) in the for loop and by telling the <code>@njit</code> decorator that parallelisation is allowed. This takes a little bit of modifying… The <code>get_first_derivative</code> function now looks like:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span>(parallel<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_first_derivative(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    phi: np.ndarray, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    num_grid_points: <span class="bu">int</span>, </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    grid_spacing: <span class="bu">float</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    d_phi <span class="op">=</span> np.zeros(num_grid_points)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> prange(num_grid_points<span class="op">-</span><span class="dv">4</span>):</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        d_phi[i<span class="op">+</span><span class="dv">2</span>] <span class="op">=</span> (phi[i] <span class="op">-</span> <span class="dv">8</span> <span class="op">*</span> phi[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">+</span> <span class="dv">8</span> <span class="op">*</span> phi[i <span class="op">+</span> <span class="dv">3</span>] <span class="op">-</span> phi[i <span class="op">+</span> <span class="dv">4</span>]) <span class="op">/</span> (</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>            <span class="fl">12.0</span> <span class="op">*</span> grid_spacing</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d_phi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I get a <code>x2</code> speed-up on my laptop (but to see the benefit clearly, I need to incease the lattice points to <code>10_000_000</code>). Feel free to parallelise all your other fast functions too!</p>
<p>Now that things are getting more complicated, it’s at least nice that the complicated stuff is contained in the <code>get_first_derivative</code> function. This mess isn’t leaking into the <code>Soliton</code> class code, or anything like that. It’s gross but we’ve localised it.</p>
<p>Some more optimisation tips:</p>
<ul>
<li>Allocating memory is expensive. So <code>d_phi = np.zeros(num_grid_points)</code> costs time. We can save this time by <em>preallocating</em> this memory. Maybe we can keep a copy of <code>d_profile</code> and <code>dd_profile</code> in the <code>Soliton</code> class.</li>
<li>Initialising the multi-threading happens when the <code>for</code> loop is called, and it expensive. Currently we do this once during <code>get_first_derivative</code> and again during <code>dV(profile[i])</code> (if we turn this into a loop). It would be faster to only do this once. To do this our gradient flow code should look like</li>
</ul>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_dE(...):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    dE <span class="op">=</span> np.zeros(points)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> prange(points):</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        dd_at_point <span class="op">=</span> get_second_derivative_at_point(i)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        dV_array <span class="op">=</span> dV(profile[i])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        dE[i] <span class="op">=</span> dd_at_point <span class="op">-</span> dV_array</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is harder than it sounds, because <code>get_second_derivative_at_point</code> depends on which point you’re looking at. At the boundary, you have to do something different. There are a few creative solutions to deal with this. Think about it, and feel free to talk to me about them.</p>
<ul>
<li>Don’t worry about little things. Modern compilers are <em>smart</em>. If you write something like</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>my_variable <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> my_variable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is a bit stupid, because you assign a variable, then return it. It would be quicker to just <code>return 3</code>. Luckily, the compiler will say “awww, the human has set a variable equal to something then returned it on the next line. That’s so inefficient, I’ll just ignore that”. This happens <em>all the time</em>. Focus your efforts on readability and learning numba. ignore little smart things: the compiler will deal with these.</p>
</section>
<section id="refactoring" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="refactoring"><span class="header-section-number">11.2</span> Refactoring</h2>
<p>Refactoring is the practice of taking your already-written code and making it “better”. Better is hard to define: usually you want to organise it into a more logical structure, or reduce code-duplication as much as possible. I’m getting overwhelmed by the <code>soliton.py</code> file so I’m going to refactor so that the <code>Grid</code> and <code>Lagrangian</code> objects get their own files. Basically, we just move the <code>Grid</code> class and the <code>load_grid</code> function into a new file called <code>grid.py</code> and similar for the Lagrangian.</p>
<p>..</p>
<p>..</p>
<p>..</p>
<p>Ok, I did that.</p>
<p>If you run some code - it’ll break! This is because your imports currently assume that all your functions and classes are in <code>solitons.py</code>. And e.g.&nbsp;the <code>Grid</code> class relies on <code>numpy</code> which hasn’t been imported in that function.</p>
<p>The top’s of each file need updating. For <code>grid.py</code>, we should have</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>for <code>lagrangian.py</code> we have:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle <span class="im">as</span> pkl</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and <code>soliton.py</code> should contain:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># this means, from the grid file, import Grid</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .grid <span class="im">import</span> Grid</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .lagrangian <span class="im">import</span> Lagrangian</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Some tips on code smells: https://inventwithpython.com/beyond/chapter5.html If you find a code smell, some refactoring is probably in order. We have duplication in our <code>load_*</code> functions - a classic code smell.)</p>
</section>
<section id="init__" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="init__"><span class="header-section-number">11.3</span> <code>__init__</code></h2>
<p>When we use other packages we do stuff like:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>np.tanh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But currently this syntax doesn’t work for our library. To make this work we need to <em>expose</em> our functions in the package initialisation script <code>__init__.py</code>. You do this by importing the functions and classes you’d like the user to be able to use in the file. We want the users to be able to make our three classes, and to load any of them, so we’ll expose these by modifying <code>__init__.py</code> as follows:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .grid <span class="im">import</span> Grid, load_grid</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .lagrangian <span class="im">import</span> Lagrangian, load_lagrangian</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .soliton <span class="im">import</span> Soliton, load_soliton</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now a user can do something like</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> solitons1d <span class="im">as</span> sol</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>my_grid <span class="op">=</span> sol.Grid(<span class="dv">100</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="make-a-library-of-lagrangians" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="make-a-library-of-lagrangians"><span class="header-section-number">11.4</span> Make a library of Lagrangians</h2>
<p>There are a few common Lagrangians, and we could add them to our package so that users don’t have to define the potential and derivative of the potential themselves.</p>
<p>To do this we’ll build a dictionary for each theory, and store these in a dictionary of dictionaries. The dictionary will contain everything you need to build the Lagrangian. For example, the <code>phi4</code> dictionary will look like:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"V"</span>: phi4_V, <span class="st">"dV"</span>: phi4_dV, <span class="st">"vacua"</span>: [<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>]}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where we’ve seen the functions <code>phi4_V</code> and <code>phi4_dV</code> earlier in the course. I’ll make a new file called <code>lagrangian_library.py</code> and add the library to it. And a function which can make a Lagrangian from a string:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> njit</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .lagrangian <span class="im">import</span> Lagrangian</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phi4_V(x):</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.5</span><span class="op">*</span>np.<span class="bu">pow</span>(<span class="dv">1</span><span class="op">-</span>np.<span class="bu">pow</span>(x,<span class="dv">2</span>),<span class="dv">2</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phi4_dV(x):</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span>np.<span class="bu">pow</span>(x,<span class="dv">3</span>) <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>x</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>lagrangians <span class="op">=</span> {</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"phi_4"</span>: {<span class="st">"V"</span>: phi4_V, <span class="st">"dV"</span>: phi4_dV, <span class="st">"vacua"</span>: [<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>]},</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>list_of_lagrangians <span class="op">=</span> <span class="bu">list</span>(lagrangians.keys())</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_lagrangian_from_library(lagrangian_string):</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    lagrangian_dict <span class="op">=</span> lagrangians.get(lagrangian_string)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> lagrangian_dict <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>, <span class="ss">f"</span><span class="sc">{</span>lagrangian_string<span class="sc">}</span><span class="ss"> is not in the Lagrangian"</span><span class="op">\</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Library. You can view the supported Lagrangians in `solitons1d.list_of_lagrangians`"</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    lagrangian <span class="op">=</span> Lagrangian(<span class="op">**</span>lagrangian_dict)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lagrangian</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we want to the user to be able to use this when they make a <code>Soliton</code>. There are a few ways to do this - I’m going to let the user enter a string to the <code>lagrangian</code> argument of <code>Soliton</code>, so that the user can run something like:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>my_phi4_soliton <span class="op">=</span> Soliton(lagrangian<span class="op">=</span><span class="st">"phi_4"</span>, grid<span class="op">=</span>my_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can alter the bit of the <code>soliton.py</code> code where the Lagrangin is added to something like.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(lagrangian, <span class="bu">str</span>):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lagrangian <span class="op">=</span> make_lagrangian_from_library(lagrangian)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(lagrangian, Lagrangian):</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lagrangian <span class="op">=</span> lagrangian</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="st">"`lagrangian` must be a string or a Lagrangian object"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You’ll need to import the <code>make_lagrangian_from_library</code> function. And if you’d like to expose the <code>list_of_lagrangians</code> list, you need to add it the <code>__init__.py</code> file.</p>
<p>Try adding sine-Gordon theory and phi6 Lagrangians to the library.</p>
<p>We can help the user out by exposing the list of possible Lagrangian’s in the type information of the <code>lagrangian</code> argument. We do this using the <code>Literal</code> type. We need to import Literal from the typing library by adding <code>from typing import Literal</code> to the top of the <code>soltion.py</code> file. Then we update the typing information as follows:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>        lagrangian: Lagrangian <span class="op">|</span> Literal[<span class="st">"phi_4"</span>, <span class="st">"sine_Gordon"</span>],</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now when you start typing in Jupyter, the list of possible Lagrangian’s should pop up when entering the <code>lagrangian</code> argument.</p>
</section>
<section id="ideas-to-build-on-the-codebase" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="ideas-to-build-on-the-codebase"><span class="header-section-number">11.5</span> Ideas to build on the codebase</h2>
<p>These are all exercises:</p>
<ul>
<li>Add time evolution. This will look <em>a lot</em> like gradient flow, but a bit more complicated.</li>
<li>Add Arrested Newton Flow.</li>
<li>Allow for gradient flow to keep going until a certain tolerance is reached (that is: keep flowing until the functional derivative of the energy is smaller than some <code>tolerance</code>).</li>
<li>Allow for any boundary conditions.</li>
<li>Allow for various orders of derivative.</li>
<li>Allow for multiple fields</li>
<li>Write code that finds the normal modes of the soliton</li>
<li>Write code that finds the one-loop correction of the soliton</li>
</ul>
</section>
<section id="advice-on-making-code-and-figures-for-papers" class="level2" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="advice-on-making-code-and-figures-for-papers"><span class="header-section-number">11.6</span> Advice on making code and figures for papers</h2>
<p>In this course, we’ve made a package to flow 1D solitons. And you might think that you’d only make a package for this kind of thing: something you do over and over again and that anyone can benefit from. I now believe the opposite: I make a package for every project I do. Each paper has at least one package. If the paper has distinct sections, I make a package for each. I use packages from an older paper in my newer paper packages. Packages packages packages.</p>
<p>This approach comes in especially handy when you’re making presentations, or figures. When I now make a plot, I first write a script (either a Jupyter notebook or a <code>.py</code> Python script) to generate the data. Then I save the data locally. When writing the script, if I write any code that seems like it would be helpful in the future, I put this into a package.</p>
<p>Once I have the data I make a <em>different</em> script to make the Figure. I find this separation between data generation and Figure making <em>extremely</em> helpful.</p>
</section>
<section id="tests" class="level2" data-number="11.7">
<h2 data-number="11.7" class="anchored" data-anchor-id="tests"><span class="header-section-number">11.7</span> Tests</h2>
<p>Why are tests important. You would think it’s to check that our code does what we say it does. But actually the most important reason to make tests is so that you can confidently change and updated your code. Try to get into the habit of re-running your tests every time you make a non-trivial change to your code.</p>
<p>A “unit” test should check one, small, piece of your code and makes sure it does what you’re expecting. Ideally you are testing just one function or method.<br>
Tests can also check that your code fails in the correct way. Ideally, every single line of code in run during your tests. Codebases get a “code coverage” score, which is the percentage of lines that are tested during a test run. Aim for 100%.</p>
<p>The most common testing tool in python is called <code>pytest</code>. For this, we can make a tests directory and create a test script in it. People structure this in different ways: we’ll make a directory in <code>src/soltion1d</code> called <code>tests</code> then make a python script called <code>all_tests.py</code> in this.</p>
<p>In <code>all_tests.py</code>, I’ll write a function which tests the first derivative function. (General rule: you don’t need to be as carefuly with typing and docstrings for tests. But it’s a good idea to write what you’re trying to test in the docstring, and how you’ll do it).</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solitons1d.soliton <span class="im">import</span> get_first_derivative</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_first_derivative():</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes the first derivative of the function f(x) = 2x and checks</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">    that it is 2.</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    lattice_spacing <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    linear_function <span class="op">=</span> <span class="dv">2</span><span class="op">*</span>np.arange(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,lattice_spacing)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    first_derivative <span class="op">=</span> get_first_derivative(linear_function, <span class="bu">len</span>(linear_function), lattice_spacing)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Don't include the boundary points, which will be zero</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> np.allclose(first_derivative[<span class="dv">2</span>:<span class="op">-</span><span class="dv">2</span>], <span class="fl">2.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To run the test suit we need to add <code>pytest</code> to our package by running <code>uv add pytest</code> in Terminal, while <code>cd</code>d in the project. Then we can run <code>uv run pytest</code>. I get the following output:</p>
<p>Now let’s make a test to check that constructing a <code>Grid</code> works as expected:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_grid_construction():</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Makes a grid object and checks that data is propagated to the object.</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Then checks that an error is raised the number of lattice points is given as</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">    a float.</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    num_grid_points <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    grid_spacing <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> Grid(num_grid_points<span class="op">=</span>num_grid_points, grid_spacing<span class="op">=</span>grid_spacing)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check that arguments become attributes of the object</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> grid.num_grid_points <span class="op">==</span> num_grid_points</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> grid.grid_spacing <span class="op">==</span> grid_spacing</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Exercise: write tests for <em>everything</em>! Ideally, you’d write tests as you go along.</p>
</section>
</section>
<section id="coming-soon" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Coming soon…</h1>
<section id="linters-and-formatters" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="linters-and-formatters"><span class="header-section-number">12.1</span> Linters and formatters</h2>
</section>
<section id="documentation" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="documentation"><span class="header-section-number">12.2</span> Documentation</h2>
</section>
<section id="continuous-integration" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="continuous-integration"><span class="header-section-number">12.3</span> Continuous Integration</h2>
</section>
<section id="recommended-readinglisteningwatching" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="recommended-readinglisteningwatching"><span class="header-section-number">12.4</span> Recommended Reading/Listening/Watching</h2>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/chrishalcrow\.github\.io\/SIG_soliton_numerics\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>